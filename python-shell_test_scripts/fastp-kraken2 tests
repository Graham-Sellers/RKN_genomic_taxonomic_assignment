#fastp
################################################################################
# FASTP QUALITY CONTROL
# disabled adapter detection, chop front 30 bases, minimum q score 15, minimum length 2000

path=/media/graham/Storage/nems

mkdir $path/nanopore_test_data/03_qc/fastp_out/
mkdir $path/nanopore_test_data/03_qc/failed_out/

samples=$(ls $path/nanopore_test_data/01_nanopore_fastq_HAC_barcode_qfilterpass/ | grep '.fastq' | sed 's/.fastq//')

for sample in $samples
do
    fastp -i $path/nanopore_test_data/01_nanopore_fastq_HAC_barcode_qfilterpass/${sample}.fastq \
    -o $path/nanopore_test_data/03_qc/${sample}.fastq \
    -A \
    -f 30 \
    -q 15 \
    -l 2000 \
    --failed_out $path/nanopore_test_data/03_qc/failed_out/${sample}_failed.fastq \
    -h $path/nanopore_test_data/03_qc/fastp_out/${sample}_fastp.html \
    -j $path/nanopore_test_data/03_qc/fastp_out/${sample}_fastp.json
done

################################################################################
# KRAKEN2 QC FASTQ INPUT
# using fastq input from fastp for Kraken2 with a small confidence value (0.01)
# additionally uses --minimum-base-quality 10 (another level of quality control)
# bases/reads below this quality are ignored for taxonomic assignment

path=/media/graham/Storage/nems

mkdir $path/nanopore_test_data/output/HAC_fastq_input/kraken2_standard_qc

files=$(ls $path/nanopore_test_data/03_qc/ | grep '.fastq' | sed 's/.fastq//')

for a in $files
do
kraken2 --db $path/meloidogyne_dbs/meloidogyne_tomato_m1_db \
$path/nanopore_test_data/03_qc/${a}.fastq \
--minimum-base-quality 10 \
--use-names \
--memory-mapping \
--threads 10 \
--confidence 0.01 \
--output $path/nanopore_test_data/output/HAC_fastq_input/kraken2_standard_qc/${a}.tsv \
--report $path/nanopore_test_data/output/HAC_fastq_input/kraken2_standard_qc/${a}.txt
done
